<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Analytics Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.5.0/Recharts.js"></script>
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <script type="text/babel" src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/recharts@2.5.0/dist/Recharts.js"></script>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const { BarChart, Bar, PieChart, Pie, Cell, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } = Recharts;

        function App() {
            const [visits, setVisits] = useState([]);
            const [stats, setStats] = useState({
                totalVisits: 0,
                uniqueVisitors: 0,
                topSources: [],
                topCampaigns: [],
                recentVisits: []
            });
            const [isLoading, setIsLoading] = useState(true);
            const [password, setPassword] = useState('');
            const [isAuthenticated, setIsAuthenticated] = useState(false);

            const COLORS = ['#2563eb', '#f59e0b', '#10b981', '#ef4444', '#8b5cf6', '#ec4899'];

            useEffect(() => {
                if (isAuthenticated) {
                    loadAnalytics();
                }
            }, [isAuthenticated]);

            const loadAnalytics = async () => {
                try {
                    if (!window.storage) {
                        alert('Storage API not available. This dashboard needs to be accessed through claude.ai artifacts.');
                        setIsLoading(false);
                        return;
                    }

                    const result = await window.storage.list('visit:', true);
                    
                    if (result && result.keys && result.keys.length > 0) {
                        const allVisits = await Promise.all(
                            result.keys.map(async (key) => {
                                try {
                                    const data = await window.storage.get(key, true);
                                    return data ? JSON.parse(data.value) : null;
                                } catch {
                                    return null;
                                }
                            })
                        );

                        const validVisits = allVisits.filter(v => v !== null);
                        setVisits(validVisits);
                        calculateStats(validVisits);
                    } else {
                        setVisits([]);
                        calculateStats([]);
                    }
                } catch (error) {
                    console.error('Error loading analytics:', error);
                    alert('Error loading analytics data. Make sure you have tracking enabled on your portfolio.');
                    setVisits([]);
                    calculateStats([]);
                } finally {
                    setIsLoading(false);
                }
            };

            const calculateStats = (visitsData) => {
                if (!visitsData || visitsData.length === 0) {
                    setStats({
                        totalVisits: 0,
                        uniqueVisitors: 0,
                        topSources: [],
                        topCampaigns: [],
                        recentVisits: []
                    });
                    return;
                }

                const sources = {};
                const campaigns = {};
                const uniqueIPs = new Set();

                visitsData.forEach(visit => {
                    const source = visit.referrer || visit.utmSource || 'Direct';
                    sources[source] = (sources[source] || 0) + 1;
                    
                    if (visit.utmCampaign) {
                        campaigns[visit.utmCampaign] = (campaigns[visit.utmCampaign] || 0) + 1;
                    }
                    
                    if (visit.ip) uniqueIPs.add(visit.ip);
                });

                const topSources = Object.entries(sources)
                    .map(([name, value]) => ({ name, value }))
                    .sort((a, b) => b.value - a.value)
                    .slice(0, 5);

                const topCampaigns = Object.entries(campaigns)
                    .map(([name, value]) => ({ name, value }))
                    .sort((a, b) => b.value - a.value)
                    .slice(0, 5);

                const recentVisits = [...visitsData]
                    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                    .slice(0, 20);

                setStats({
                    totalVisits: visitsData.length,
                    uniqueVisitors: uniqueIPs.size,
                    topSources,
                    topCampaigns,
                    recentVisits
                });
            };

            const handleLogin = () => {
                if (password === 'prem2025') {
                    setIsAuthenticated(true);
                } else {
                    alert('Incorrect password');
                }
            };

            const clearAllData = async () => {
                if (window.confirm('Are you sure you want to clear all analytics data? This cannot be undone.')) {
                    try {
                        const result = await window.storage.list('visit:', true);
                        if (result && result.keys) {
                            await Promise.all(
                                result.keys.map(key => window.storage.delete(key, true))
                            );
                        }
                        setVisits([]);
                        calculateStats([]);
                        alert('All analytics data cleared');
                    } catch (error) {
                        console.error('Error clearing data:', error);
                        alert('Error clearing data');
                    }
                }
            };

            const formatDate = (timestamp) => {
                return new Date(timestamp).toLocaleString();
            };

            const getLocationString = (visit) => {
                const parts = [];
                if (visit.city) parts.push(visit.city);
                if (visit.region) parts.push(visit.region);
                if (visit.country) parts.push(visit.country);
                return parts.length > 0 ? parts.join(', ') : 'Unknown';
            };

            if (!isAuthenticated) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
                        <div className="bg-white rounded-lg shadow-xl p-8 max-w-md w-full">
                            <h2 className="text-2xl font-bold text-gray-800 mb-6 text-center">Analytics Dashboard</h2>
                            <div className="space-y-4">
                                <input
                                    type="password"
                                    placeholder="Enter password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    onKeyPress={(e) => e.key === 'Enter' && handleLogin()}
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                />
                                <button
                                    onClick={handleLogin}
                                    className="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition"
                                >
                                    Login
                                </button>
                            </div>
                            <p className="text-sm text-gray-500 mt-4 text-center">
                                Default password: prem2025
                            </p>
                        </div>
                    </div>
                );
            }

            if (isLoading) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center">
                        <div className="text-center">
                            <div className="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-600 mx-auto"></div>
                            <p className="mt-4 text-gray-600">Loading analytics...</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4 md:p-8">
                    <div className="max-w-7xl mx-auto">
                        {/* Header */}
                        <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                            <div className="flex justify-between items-center flex-wrap gap-4">
                                <div>
                                    <h1 className="text-3xl font-bold text-gray-800">Portfolio Analytics</h1>
                                    <p className="text-gray-600 mt-1">Track your website visitors and engagement</p>
                                </div>
                                <div className="flex gap-3">
                                    <button
                                        onClick={loadAnalytics}
                                        className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
                                    >
                                        Refresh Data
                                    </button>
                                    <button
                                        onClick={clearAllData}
                                        className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition"
                                    >
                                        Clear All
                                    </button>
                                </div>
                            </div>
                        </div>

                        {/* Stats Cards */}
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                            <div className="bg-white rounded-lg shadow-lg p-6">
                                <p className="text-gray-600 text-sm font-medium">Total Visits</p>
                                <p className="text-3xl font-bold text-blue-600 mt-2">{stats.totalVisits}</p>
                            </div>
                            <div className="bg-white rounded-lg shadow-lg p-6">
                                <p className="text-gray-600 text-sm font-medium">Unique Visitors</p>
                                <p className="text-3xl font-bold text-green-600 mt-2">{stats.uniqueVisitors}</p>
                            </div>
                            <div className="bg-white rounded-lg shadow-lg p-6">
                                <p className="text-gray-600 text-sm font-medium">Top Source</p>
                                <p className="text-xl font-bold text-purple-600 mt-2">
                                    {stats.topSources[0]?.name || 'N/A'}
                                </p>
                            </div>
                        </div>

                        {/* Recent Visits Table */}
                        <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                            <h2 className="text-xl font-bold text-gray-800 mb-4">Recent Visits</h2>
                            {stats.recentVisits.length > 0 ? (
                                <div className="overflow-x-auto">
                                    <table className="w-full">
                                        <thead>
                                            <tr className="border-b">
                                                <th className="text-left py-3 px-4 font-semibold text-gray-700">Date & Time</th>
                                                <th className="text-left py-3 px-4 font-semibold text-gray-700">Location</th>
                                                <th className="text-left py-3 px-4 font-semibold text-gray-700">Source</th>
                                                <th className="text-left py-3 px-4 font-semibold text-gray-700">Campaign</th>
                                                <th className="text-left py-3 px-4 font-semibold text-gray-700">Device</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {stats.recentVisits.map((visit, index) => (
                                                <tr key={index} className="border-b hover:bg-gray-50">
                                                    <td className="py-3 px-4 text-sm text-gray-600">{formatDate(visit.timestamp)}</td>
                                                    <td className="py-3 px-4 text-sm text-gray-600">{getLocationString(visit)}</td>
                                                    <td className="py-3 px-4 text-sm">
                                                        <span className="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-medium">
                                                            {visit.referrer || visit.utmSource || 'Direct'}
                                                        </span>
                                                    </td>
                                                    <td className="py-3 px-4 text-sm text-gray-600">
                                                        {visit.utmCampaign || '-'}
                                                    </td>
                                                    <td className="py-3 px-4 text-sm text-gray-600">{visit.device || 'Unknown'}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            ) : (
                                <div className="text-center py-12">
                                    <p className="text-gray-500 text-lg mb-4">No visits recorded yet</p>
                                    <p className="text-gray-400 text-sm">Make sure the tracking script is added to your portfolio and it's deployed online</p>
                                </div>
                            )}
                        </div>

                        {/* Instructions */}
                        <div className="bg-blue-50 border border-blue-200 rounded-lg p-6">
                            <h3 className="font-bold text-blue-900 mb-2">ðŸ“Š How to Track Campaigns</h3>
                            <p className="text-blue-800 mb-3">Create custom tracking links:</p>
                            <div className="bg-white rounded p-3 font-mono text-sm text-gray-700 mb-3">
                                yourportfolio.com?utm_campaign=google_application<br/>
                                yourportfolio.com?utm_source=linkedin&utm_campaign=recruiter_john
                            </div>
                            <p className="text-blue-800 text-sm">
                                Share different links with different companies to track who views your portfolio!
                            </p>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>